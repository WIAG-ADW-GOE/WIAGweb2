{% extends 'base.html.twig' %}
{% set menuItem='collections' %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}

{% block body %}
    {% if not canonlookup%}
	<p class="em">Domherr nicht gefunden.</p>
    {% else %}
	{% set person = canonlookup[0].person %}
	{% set idpublic = person.item.idpublic %}
	{% set permalink %}{{ protocol }}:{{ url('id', {id: idpublic}, schemeRelative = true) }}{% endset %}
	{% set citation %}"{{ person.displayname }}" in: WIAG, {{ protocol }}:{{ url('id', {id: idpublic}, schemeRelative = true) }} (Abgerufen: {{ "now"|date('d.m.Y') }}).{% endset %}
	{% set btnpanel %}
	<div class="row mx-2 col-12 mt-4 mb-2">
	    <div class="d-flex">
		{% if form is defined %}
		    {{ include('canon/_button_step.html.twig',
			{value: offset - 1, disabled: offset == 0, text: 'vorheriger Treffer'}) }}
		    {{ include('canon/_button_step.html.twig',
			{value: offset + 1, disabled: not hassuccessor, text: 'nächster Treffer'}) }}
		    <button type="submit" form="form" class="btn btn-outline-secondary btn-sm me-1" name="offset" value="{{ offset }}">Ergebnisliste</button>
		    <a href="{{ path('canon_query') }}" type="button" class="btn btn-outline-secondary btn-sm me-3">Neue Suche</a>
		{% else %}
		    <a href="{{ path('canon_query') }}" type="button" class="btn btn-outline-secondary btn-sm me-3">Suche</a>
		{% endif %}
		{% set btnaction=path('id', {id: idpublic}) %}
		{{ include('canon/_button_data.html.twig',
		    {action: btnaction, format: 'Csv', text: 'CSV' }) }}
		{{ include('canon/_button_data.html.twig',
		    {action: btnaction, format: 'Rdf', text: 'RDF-XML' }) }}
		{{ include('canon/_button_data.html.twig',
		    {action: btnaction, format: 'Json', text: 'JSON' }) }}
		{{ include('canon/_button_data.html.twig', {action: btnaction, format: 'Jsonld', text: 'JSON-LD' }) }}
	    </div>
	</div>
	{% endset %}
	{% if form is defined %}
	    {{ form_start(form, {'attr': {'id':'form', 'action':path('canon_query'), 'hidden': 'hidden'} }) }}
		{{ include('canon/_form_elements.html.twig') }}
	    {{ form_end(form) }}
	{% endif %}
	<div class="container-fluid mt-3 mb-2">
	    <div class="row mx-2 col-12">
		<span class="topic-title">{{ canon_title }}</span>
	    </div>
	    {{ btnpanel }}
	    {# name and button to copy permalink to the clipboard #}
	    <div class="row col-12 mx-2 mt-2 mb-0">
		<div class="d-flex justify-content-between">
		    <span class="fs-2">{{ person.displayname[:200] }}</span>
		    <button type="button"
			    class="btn"
			    title={{ permalink }}
			    {{ stimulus_controller('clipboard') }}
			    data-action="clipboard#copyTitle">{{ person.item.idPublic }} <img src="{{ asset('images/link45deg.svg') }}" width="18"></button>
		</div>
	    </div>
	    {# comments, dates #}
	    {% if person.commentLine %}
		<div class="row mx-2">
		    <div class="col-12 comment">
			{{ person.commentLine }}
		    </div>
		</div>
	    {% endif %}

	    {% if not person.datebirth and not person.datedeath %}
	    {% else %}
		<div class="row mx-2 col-12 mt-2">
		    {% if person.datebirth and not person.datedeath %}
			<span class="wiag-large">* {{ person.datebirth }}</span>
		    {% elseif not person.datebirth and person.datedeath %}
			<span class="wiag-large">&dagger; {{ person.datedeath }}</span>
		    {% else %}
			<span class="wiag-large">* {{ person.datebirth }} <span class="pl-3">&dagger; {{ person.datedeath }}</span></span>
		    {% endif %}
		</div>
	    {% endif %}
	    {# offices and references#}
	    {# canon is in Domherrendatenbank #}
	    {% set person = null %}
	    {% set hascanon = false %}
	    {% set hascanongs = false %}
	    {% set hasbishop = false %}
	    {% for canon in canonlookup %}
		{% if canon.personRole.item.itemtypeid == 5 %}
		    {% set person = canon.personRole %}
		    {% set hascanon = true %}
		{% endif %}
	    {% endfor %}
	    {% if person %}
		{{ include('canon/_person_role_group.html.twig', {
		    person: person,
		    title: 'Amtsangaben aus Referenzwerken',
		    with_context: false,
		}) }}
	    {% endif %}
	    {% set person = null %}
	    {# canon is in Digitalem Personenregister #}
	    {% for canon in canonlookup %}
		{% if canon.personRole.item.itemtypeid == 6 %}
		    {% set person = canon.personRole %}
		    {% set hascanongs = true %}
		{% endif %}
	    {% endfor %}
	    {% if person %}
		{% set gsnid = person.item.getidexternalobj('GS') %}
		{% set title %}
		<a href="{{ gsnid.authority.urlformatter~gsnid.value  }}" target="_blank" rel="noopener"><strong>Amtsangaben aus dem Digitalen Personenregister der Germania Sacra — {{ gsnid.value }}</strong></a>
		{% endset %}
		{{ include('canon/_person_role_group.html.twig', {
		    person: person,
		    title: title,
		    with_context: false
		}) }}
	    {% endif %}
	    {% set person = null %}
	    {# canon is in Gatz bishops #}
	    {% set bishopid = null %}
	    {% for canon in canonlookup %}
		{% if canon.personRole.item.itemtypeid == 4 %}
		    {% set person = canon.personRole %}
		    {% set hasbishop = true %}
		    {% set bishopid = person.item.idpublic %}
		{% endif %}
	    {% endfor %}
	    {% if person %}
		{% set title %}
		<a href="{{ path('id', {id: bishopid}) }}" target="_blank" rel="noopener"><strong>Amtsangaben aus der Datenbank Bischöfe des Alten Reiches (WIAG) — {{ bishopid }}</strong></a>
		{% endset %}
		{{ include('canon/_person_role_group.html.twig', {
		    person: person,
		    title: title,
		    with_context: false
		}) }}
	    {% endif %}
	    {# external IDs #}
	    {% if not (hascanongs and hasbishop and not hascanon) %}
		{% set bishopid = null %}
	    {% endif %}
	    {# select person with highest role priority (Domherr > Domherr GS > Bishop) #}
	    {% set person = canonlookup[0].person %}
	    {% if (person.item.idExternal and person.item.idExternal|length > 0) or bishopid %}
		<div class="row mx-2 mt-3 mb-2">
		    <div class="col-12">
			{{ include('canon/_person_id_external.html.twig', {
			    epid: bishopid,
			    ids: person.item.idExternal
			}) }}
		    </div>
		</div>
	    {% endif %}
	    {% for urltype in person.urlbytype|keys %}
		<div class="row mx-2 mt-3 mb-2">
		    <div class="col-12">
			{{ include('canon/_person_url_external.html.twig', {
			    urltype: urltype,
			    urls: person.urlbytype[urltype],
			}) }}
		    </div>
		</div>
	    {% endfor %}
	    <div class="row mx-2">
		<div class="col-12">
		    Empfohlene Zitierweise:
		    <button type="button"
			    class="btn btn-sm"
			    title="Kopiere die Zitierweise"
			    {{ stimulus_controller('clipboard') }}
			    data-action="clipboard#copyCitation"><img src="{{ asset('images/clipboard.svg') }}"></button><br/>
		    <span id="citation">{{ citation }}</span>
		</div>
	    </div>
	    {# button line #}
	    {{ btnpanel }}
	</div>
    {% endif %}
{% endblock %}
